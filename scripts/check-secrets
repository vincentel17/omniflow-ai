#!/usr/bin/env python3
from __future__ import annotations

import re
import subprocess
import sys
from pathlib import Path


PATTERNS: list[tuple[str, re.Pattern[str]]] = [
    ("aws_access_key", re.compile(r"AKIA[0-9A-Z]{16}")),
    ("private_key_block", re.compile(r"-----BEGIN (?:RSA |EC |OPENSSH )?PRIVATE KEY-----")),
    ("token_assignment", re.compile(r"(?i)(access_token|refresh_token|api_key|secret)\s*[:=]\s*['\"][^'\"]{8,}['\"]")),
    ("bearer_token", re.compile(r"(?i)bearer\s+[a-z0-9._-]{16,}")),
]

SKIP_EXTENSIONS = {
    ".png",
    ".jpg",
    ".jpeg",
    ".gif",
    ".webp",
    ".pdf",
    ".woff",
    ".woff2",
    ".ttf",
    ".eot",
}

SKIP_PREFIXES = (
    "node_modules/",
    ".next/",
    ".git/",
    "dist/",
    "build/",
    "coverage/",
    ".turbo/",
    ".cache/",
)


def tracked_files() -> list[str]:
    result = subprocess.run(
        ["git", "ls-files"],
        check=True,
        capture_output=True,
        text=True,
    )
    return [line.strip() for line in result.stdout.splitlines() if line.strip()]


def should_skip(path: str) -> bool:
    normalized = path.replace("\\", "/")
    if normalized.startswith(SKIP_PREFIXES):
        return True
    suffix = Path(normalized).suffix.lower()
    return suffix in SKIP_EXTENSIONS


def main() -> int:
    findings: list[str] = []
    root = Path.cwd()

    for rel_path in tracked_files():
        if should_skip(rel_path):
            continue
        file_path = root / rel_path
        try:
            text = file_path.read_text(encoding="utf-8")
        except UnicodeDecodeError:
            continue
        except OSError:
            continue

        for line_number, line in enumerate(text.splitlines(), start=1):
            for label, pattern in PATTERNS:
                if pattern.search(line):
                    findings.append(f"{rel_path}:{line_number} [{label}]")
                    break

    if findings:
        print("Potential secrets detected:")
        for finding in findings[:50]:
            print(f" - {finding}")
        if len(findings) > 50:
            print(f" - ... {len(findings) - 50} more")
        return 1

    print("No obvious hardcoded secrets detected in tracked files.")
    return 0


if __name__ == "__main__":
    sys.exit(main())
